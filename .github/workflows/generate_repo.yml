name: Generate And Provision Project Repo
on:
  workflow_dispatch:
    inputs:
      project_name:
        description: Project name
        required: true
        type: string
      task_type:
        description: Task type
        required: true
        type: choice
        options:
          - supervised
          - unsupervised
        default: supervised
      data_type:
        description: Data type
        required: true
        type: choice
        options:
          - tabular
          - image
          - database
        default: tabular
      deployment:
        description: Deployment target
        required: true
        type: choice
        options:
          - all
          - ray-serve
          - ray-batch
          - none
        default: all
      owner:
        description: GitHub org or user to create repo under
        required: false
        type: string
      repo_private:
        description: Create repository as private? (true = private, false = public)
        required: false
        type: choice
        options:
          - true
          - false
        default: true
jobs:
  generate:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
      - name: Install dependencies
        run: |
          pip install jinja2
          sudo apt-get update -y
          sudo apt-get install -y jq
      - name: Validate project name
        run: |
          set -e
          PN="${{ github.event.inputs.project_name }}"
          [ -n "$PN" ] || { echo "PROJECT_NAME is required"; exit 1; }
          echo "$PN" | grep -Eq '^[A-Za-z0-9_.-]+$' || { echo "Invalid PROJECT_NAME"; exit 1; }
      - name: Set repo private flag
        id: set_repo_private
        run: |
          # Normalize workflow input to 'true' or 'false'
          INPUT="${{ github.event.inputs.repo_private }}"
          if [ -z "$INPUT" ]; then
            INPUT="true"
          fi
          case "$INPUT" in
            true|True|TRUE|1|yes|Yes|YES) RP=true ;;
            false|False|FALSE|0|no|No|NO) RP=false ;;
            *) RP=true ;; # default to true to preserve previous behavior
          esac
          echo "repo_private=$RP" >> $GITHUB_OUTPUT
      - name: Generate scaffold
        run: |
          mkdir -p generated_projects
          python scripts/scaffold_project.py \
            --name "${{ github.event.inputs.project_name }}" \
            --task-type "${{ github.event.inputs.task_type }}" \
            --data-type "${{ github.event.inputs.data_type }}" \
            --deployment "${{ github.event.inputs.deployment }}" \
            --output-dir generated_projects
      - name: Create repository
        env:
          GH_TOKEN: ${{ secrets.GH_ADMIN_TOKEN }}
          OWNER_INPUT: ${{ github.event.inputs.owner }}
        run: |
          set -e
          OWNER="${OWNER_INPUT:-${{ github.repository_owner }}}"
          NAME="${{ github.event.inputs.project_name }}"
          API="https://api.github.com"
          REPO_PRIVATE="${{ steps.set_repo_private.outputs.repo_private }}"
          # Check existence
          STATUS=$(curl -s -o /dev/null -w "%{http_code}" \
            -H "Authorization: token ${GH_TOKEN}" \
            -H "Accept: application/vnd.github+json" \
            "${API}/repos/${OWNER}/${NAME}")
          if [ "$STATUS" -eq 200 ]; then
            echo "Repository ${OWNER}/${NAME} already exists"
            exit 1
          fi
          # Try create in org
          CREATE_ORG_STATUS=$(curl -s -o /dev/null -w "%{http_code}" \
            -H "Authorization: token ${GH_TOKEN}" \
            -H "Accept: application/vnd.github+json" \
            -d "{\"name\":\"${NAME}\",\"private\":${REPO_PRIVATE}}" \
            "${API}/orgs/${OWNER}/repos")
          if [ "$CREATE_ORG_STATUS" -ge 200 ] && [ "$CREATE_ORG_STATUS" -lt 300 ]; then
            echo "Repository created in org ${OWNER}"
          else
            CREATE_USER_STATUS=$(curl -s -o /dev/null -w "%{http_code}" \
              -H "Authorization: token ${GH_TOKEN}" \
              -H "Accept: application/vnd.github+json" \
              -d "{\"name\":\"${NAME}\",\"private\":${REPO_PRIVATE}}" \
              "${API}/user/repos")
            if [ "$CREATE_USER_STATUS" -ge 200 ] && [ "$CREATE_USER_STATUS" -lt 300 ]; then
              echo "Repository created under user"
            else
              # Dump response for debugging
              echo "Failed to create repository"
              echo "Org create status: $CREATE_ORG_STATUS"
              echo "User create status: $CREATE_USER_STATUS"
              exit 1
            fi
          fi
      - name: Push scaffold to repository
        env:
          GH_TOKEN: ${{ secrets.GH_ADMIN_TOKEN }}
          OWNER_INPUT: ${{ github.event.inputs.owner }}
        run: |
          set -e
          OWNER="${OWNER_INPUT:-${{ github.repository_owner }}}"
          NAME="${{ github.event.inputs.project_name }}"
          cd "generated_projects/${NAME}"
          git init
          git config user.name "${{ github.actor }}"
          git config user.email "${{ github.actor }}@users.noreply.github.com"
          git add .
          git commit -m "Initial scaffold"
          git branch -M main
          git remote add origin "https://x-access-token:${GH_TOKEN}@github.com/${OWNER}/${NAME}.git"
          git push -u origin main
      - name: Get repository information
        id: repo_info
        env:
          GH_TOKEN: ${{ secrets.GH_ADMIN_TOKEN }}
          OWNER_INPUT: ${{ github.event.inputs.owner }}
        run: |
          set -e
          OWNER="${OWNER_INPUT:-${{ github.repository_owner }}}"
          NAME="${{ github.event.inputs.project_name }}"
          API="https://api.github.com"
          RESP_FILE=$(mktemp)
          STATUS=$(curl -s -H "Authorization: token ${GH_TOKEN}" \
            -H "Accept: application/vnd.github+json" \
            "${API}/repos/${OWNER}/${NAME}" -o "$RESP_FILE" -w "%{http_code}")
          echo "status=$STATUS" >> $GITHUB_OUTPUT
          # parse .private field; fallback to the workflow input if parsing fails
          IS_PRIVATE=$(jq -r '.private // empty' "$RESP_FILE" 2>/dev/null || echo "")
          if [ -z "$IS_PRIVATE" ]; then
            IS_PRIVATE="${{ steps.set_repo_private.outputs.repo_private }}"
          fi
          # normalize to 'true' or 'false'
          if [ "$IS_PRIVATE" = "true" ] || [ "$IS_PRIVATE" = "True" ]; then
            IS_PRIVATE=true
          else
            IS_PRIVATE=false
          fi
          echo "is_private=$IS_PRIVATE" >> $GITHUB_OUTPUT
      - name: Protect main branch
        if: steps.repo_info.outputs.is_private == 'false'
        env:
          GH_TOKEN: ${{ secrets.GH_ADMIN_TOKEN }}
          OWNER_INPUT: ${{ github.event.inputs.owner }}
        run: |
          set -e
          OWNER="${OWNER_INPUT:-${{ github.repository_owner }}}"
          NAME="${{ github.event.inputs.project_name }}"
          API="https://api.github.com"

          # Wait for the main branch to be available (retry up to ~30s)
          for i in $(seq 1 15); do
            STATUS=$(curl -s -o /dev/null -w "%{http_code}" \
              -H "Authorization: token ${GH_TOKEN}" \
              -H "Accept: application/vnd.github+json" \
              "${API}/repos/${OWNER}/${NAME}/branches/main")
            if [ "$STATUS" -eq 200 ]; then
              echo "Branch main found"
              break
            fi
            echo "Branch main not found yet (status: $STATUS), retrying... ($i/15)"
            sleep 2
          done

          if [ "$STATUS" -ne 200 ]; then
            echo "main branch not available after retries"
            exit 1
          fi

          # Apply branch protection
          RESP=$(curl -s -o /tmp/protect_resp_body -w "%{http_code}" -X PUT \
            -H "Authorization: token ${GH_TOKEN}" \
            -H "Accept: application/vnd.github+json" \
            "${API}/repos/${OWNER}/${NAME}/branches/main/protection" \
            -d '{"required_status_checks":null,"enforce_admins":true,"required_pull_request_reviews":{"required_approving_review_count":1},"restrictions":null}')
          if [ "$RESP" -lt 200 ] || [ "$RESP" -ge 300 ]; then
            echo "Failed to protect main branch (status: $RESP)"
            echo "Response body:"
            cat /tmp/protect_resp_body || true
            exit 1
          fi
