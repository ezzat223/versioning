name: Generate And Provision Project Repo
on:
  workflow_dispatch:
    inputs:
      project_name:
        description: Project name
        required: true
        type: string
      task_type:
        description: Task type
        required: true
        type: choice
        options:
          - supervised
          - unsupervised
        default: supervised
      data_type:
        description: Data type
        required: true
        type: choice
        options:
          - tabular
          - image
          - database
        default: tabular
      deployment:
        description: Deployment target
        required: true
        type: choice
        options:
          - all
          - ray-serve
          - ray-batch
          - none
        default: all
      owner:
        description: GitHub org or user to create repo under
        required: false
        type: string
      visibility:
        description: Visibility for the generated repository
        required: false
        type: choice
        options:
          - private
          - public
        default: private

jobs:
  generate:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: pip install jinja2

      - name: Validate project name
        run: |
          set -e
          PN="${{ github.event.inputs.project_name }}"
          [ -n "$PN" ] || { echo "PROJECT_NAME is required"; exit 1; }
          echo "$PN" | grep -Eq '^[A-Za-z0-9_.-]+$' || { echo "Invalid PROJECT_NAME"; exit 1; }

      - name: Generate scaffold
        run: |
          mkdir -p generated_projects
          python scripts/scaffold_project.py \
            --name "${{ github.event.inputs.project_name }}" \
            --task-type "${{ github.event.inputs.task_type }}" \
            --data-type "${{ github.event.inputs.data_type }}" \
            --deployment "${{ github.event.inputs.deployment }}" \
            --output-dir generated_projects

      - name: Create repository
        env:
          GH_TOKEN: ${{ secrets.GH_ADMIN_TOKEN }}
          OWNER_INPUT: ${{ github.event.inputs.owner }}
          VIS_INPUT: ${{ github.event.inputs.visibility }}
        run: |
          set -e
          OWNER="${OWNER_INPUT:-${{ github.repository_owner }}}"
          NAME="${{ github.event.inputs.project_name }}"
          VIS="${VIS_INPUT:-private}"
          API="https://api.github.com"

          # Determine private boolean for payload
          if [ "$VIS" = "public" ]; then
            PRIVATE=false
          else
            PRIVATE=true
          fi

          # If repo already exists, fail early
          STATUS=$(curl -s -o /dev/null -w "%{http_code}" \
            -H "Authorization: token ${GH_TOKEN}" \
            -H "Accept: application/vnd.github+json" \
            "${API}/repos/${OWNER}/${NAME}")
          if [ "$STATUS" -eq 200 ]; then
            echo "Repository ${OWNER}/${NAME} already exists"
            exit 1
          fi

          # Try to create under an org first
          CREATE_ORG_STATUS=$(curl -s -o /dev/null -w "%{http_code}" \
            -H "Authorization: token ${GH_TOKEN}" \
            -H "Accept: application/vnd.github+json" \
            -d "{\"name\":\"${NAME}\",\"private\":${PRIVATE}}" \
            "${API}/orgs/${OWNER}/repos")
          if [ "$CREATE_ORG_STATUS" -ge 200 ] && [ "$CREATE_ORG_STATUS" -lt 300 ]; then
            echo "Repository created in org ${OWNER}"
          else
            # Fallback to creating under the authenticated user
            CREATE_USER_STATUS=$(curl -s -o /dev/null -w "%{http_code}" \
              -H "Authorization: token ${GH_TOKEN}" \
              -H "Accept: application/vnd.github+json" \
              -d "{\"name\":\"${NAME}\",\"private\":${PRIVATE}}" \
              "${API}/user/repos")
            if [ "$CREATE_USER_STATUS" -ge 200 ] && [ "$CREATE_USER_STATUS" -lt 300 ]; then
              echo "Repository created under user"
            else
              echo "Failed to create repository (org status: ${CREATE_ORG_STATUS}, user status: ${CREATE_USER_STATUS})"
              exit 1
            fi
          fi

      - name: Push scaffold to repository
        env:
          GH_TOKEN: ${{ secrets.GH_ADMIN_TOKEN }}
          OWNER_INPUT: ${{ github.event.inputs.owner }}
        run: |
          set -e
          OWNER="${OWNER_INPUT:-${{ github.repository_owner }}}"
          NAME="${{ github.event.inputs.project_name }}"
          cd "generated_projects/${NAME}"
          git init
          git config user.name "${{ github.actor }}"
          git config user.email "${{ github.actor }}@users.noreply.github.com"
          git add .
          git commit -m "Initial scaffold"
          git branch -M main
          git remote add origin "https://x-access-token:${GH_TOKEN}@github.com/${OWNER}/${NAME}.git"
          git push -u origin main

      - name: Protect main branch
        env:
          GH_TOKEN: ${{ secrets.GH_ADMIN_TOKEN }}
          OWNER_INPUT: ${{ github.event.inputs.owner }}
        run: |
          set -e
          OWNER="${OWNER_INPUT:-${{ github.repository_owner }}}"
          NAME="${{ github.event.inputs.project_name }}"
          API="https://api.github.com"

          # Wait for the main branch to be available (retry up to ~30s)
          for i in $(seq 1 15); do
            STATUS=$(curl -s -o /dev/null -w "%{http_code}" \
              -H "Authorization: token ${GH_TOKEN}" \
              -H "Accept: application/vnd.github+json" \
              "${API}/repos/${OWNER}/${NAME}/branches/main")
            if [ "$STATUS" -eq 200 ]; then
              echo "Branch main found"
              break
            fi
            echo "Branch main not found yet (status: $STATUS), retrying... ($i/15)"
            sleep 2
          done

          if [ "$STATUS" -ne 200 ]; then
            echo "main branch not available after retries"
            exit 1
          fi

          # Get repository metadata so we can decide how to handle protection errors
          REPO_INFO=$(curl -s -H "Authorization: token ${GH_TOKEN}" -H "Accept: application/vnd.github+json" "${API}/repos/${OWNER}/${NAME}")
          IS_PRIVATE=$(echo "$REPO_INFO" | grep -Eo '"private":[[:space:]]*(true|false)' | head -1 | grep -Eo '(true|false)' || true)
          echo "Repository private: ${IS_PRIVATE}"

          # Apply branch protection (handle plan limitations gracefully)
          RESP=$(curl -s -o /tmp/protect_resp_body -w "%{http_code}" -X PUT \
            -H "Authorization: token ${GH_TOKEN}" \
            -H "Accept: application/vnd.github+json" \
            "${API}/repos/${OWNER}/${NAME}/branches/main/protection" \
            -d '{"required_status_checks":null,"enforce_admins":true,"required_pull_request_reviews":{"required_approving_review_count":1},"restrictions":null}')

          if [ "$RESP" -ge 200 ] && [ "$RESP" -lt 300 ]; then
            echo "Branch protection applied successfully."
            rm -f /tmp/protect_resp_body || true
          else
            echo "Branch protection API returned status: $RESP"
            echo "Response body:"
            cat /tmp/protect_resp_body || true

            # If the failure is due to plan limitations for private repos, log and continue
            if [ "$RESP" -eq 403 ]; then
              BODY=$(cat /tmp/protect_resp_body 2>/dev/null || true)
              if echo "$BODY" | grep -qi -e "Upgrade to GitHub Pro" -e "make this repository public" -e "This endpoint can only be accessed by organization owners"; then
                echo "Branch protection is not available for this account/plan or visibility. Skipping protection step."
                rm -f /tmp/protect_resp_body || true
              else
                echo "Received 403 for branch protection but reason is not a known plan/visibility limitation. Failing the job."
                rm -f /tmp/protect_resp_body || true
                exit 1
              fi
            else
              # For other non-2xx statuses, fail
              echo "Failed to protect main branch (status: $RESP)"
              rm -f /tmp/protect_resp_body || true
              exit 1
            fi
          fi
